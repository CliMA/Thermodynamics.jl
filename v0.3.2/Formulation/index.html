<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Thermodynamics overview ¬∑ Thermodynamics.jl</title><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../"><img src="../assets/logo.svg" alt="Thermodynamics.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit">Thermodynamics.jl</span></div><form class="docs-search" action="../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><a class="tocitem" href="../Installation/">Installation</a></li><li><a class="tocitem" href="../API/">API</a></li><li><a class="tocitem" href="../HowToGuide/">How-to-guide</a></li><li><a class="tocitem" href="../TestedProfiles/">Tested profiles</a></li><li><a class="tocitem" href="../TemperatureProfiles/">Temperature profiles</a></li><li><a class="tocitem" href="../DevDocs/">Developer docs</a></li><li class="is-active"><a class="tocitem" href>Thermodynamics overview</a><ul class="internal"><li><a class="tocitem" href="#Working-Fluid-and-Equation-of-State"><span>Working Fluid and Equation of State</span></a></li><li><a class="tocitem" href="#Heat-Capacities"><span>Heat Capacities</span></a></li><li><a class="tocitem" href="#Latent-Heats"><span>Latent Heats</span></a></li><li><a class="tocitem" href="#Internal-Energies"><span>Internal Energies</span></a></li><li><a class="tocitem" href="#Enthalpies"><span>Enthalpies</span></a></li><li><a class="tocitem" href="#Moist-Static-Energy"><span>Moist Static Energy</span></a></li><li><a class="tocitem" href="#Saturation-Vapor-Pressure"><span>Saturation Vapor Pressure</span></a></li><li><a class="tocitem" href="#Saturation-Specific-Humidity"><span>Saturation Specific Humidity</span></a></li><li><a class="tocitem" href="#Saturation-Adjustment"><span>Saturation Adjustment</span></a></li><li><a class="tocitem" href="#Auxiliary-Thermodynamic-Functions"><span>Auxiliary Thermodynamic Functions</span></a></li></ul></li><li><a class="tocitem" href="../References/">References</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Thermodynamics overview</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Thermodynamics overview</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/CliMA/Thermodynamics.jl/blob/master/docs/src/Formulation.md" title="Edit on GitHub"><span class="docs-icon fab">ÔÇõ</span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Mathematical-formulation"><a class="docs-heading-anchor" href="#Mathematical-formulation">Mathematical formulation</a><a id="Mathematical-formulation-1"></a><a class="docs-heading-anchor-permalink" href="#Mathematical-formulation" title="Permalink"></a></h1><p>The thermodynamics of moist air is often subject to empirical approximations, which usually are opaque, internally inconsistent, and/or inconsistent across model components. For example, microphysical process models often use different approximations for thermodynamic quantities such as saturation vapor pressures than the dynamical core. The often bewildering array of approximations makes it difficult to achieve global conservation, e.g., of energy, and it complicates the use of models for other planetary atmospheres, with different thermodynamic parameters.</p><p>Here we introduce one consistent set of thermodynamic approximations for all model components. The key to thermodynamic consistency at reasonable accuracy is to take the specific heat capacities of the constituents of moist air (dry air, water vapor, liquid water, and ice) to be constant, i.e., to assume the gases to be calorically perfect. We discuss how to derive all other thermodynamic quantities that are needed on the basis of this one approximation (<a href="../References/#Romps2008">David M Romps  (2008)</a>,<a href="../References/#Marquet2015">Pascal Marquet , Jean-Fran\c{c}}}ois Geleyn  (2015)</a>). This includes:</p><ul><li>Giving accurate and easily adaptable closed-form expressions for internal energies, enthalpies, specific latent heats, and saturation vapor pressures</li><li>Showing how to construct consistent sets of thermodynamic equations that either (i) assume equilibrium of the phases and require only one prognostic water variable, or (ii) do not assume equilibrium of the phases and require prognostic variables for all water phases</li><li>Showing how to obtain temperatures from energy variables under either phase equilibrium assumptions (by <code>saturation adjustment</code>) or phase non-equilibrium assumptions (by a closed-form expression for temperature).</li></ul><p>The resulting thermodynamic functions are implemented in <a href="https://github.com/climate-machine/CLIMA/tree/master/src/Common/Thermodynamics">Thermodynamics.jl</a>.</p><h2 id="Working-Fluid-and-Equation-of-State"><a class="docs-heading-anchor" href="#Working-Fluid-and-Equation-of-State">Working Fluid and Equation of State</a><a id="Working-Fluid-and-Equation-of-State-1"></a><a class="docs-heading-anchor-permalink" href="#Working-Fluid-and-Equation-of-State" title="Permalink"></a></h2><p>The working fluid of the atmosphere model is moist, potentially cloudy air, considered to be an ideal mixture of dry air, water vapor, and condensed water (liquid and ice) in clouds. Dry air and water vapor are taken to be ideal gases. The specific volume of the cloud condensate is neglected relative to that of the gas phases (it is a  factor <span>$10^{3}$</span> less than that of the gas phases). All phases are assumed to have the same temperature, and are advected with the same velocity. The cloud condensates may be sedimenting relative to the gas phases, but slowly enough to be in thermal equilibrium with the surrounding fluid. However, the condensates do not need to be in thermodynamic equilibrium with the other fluid constituents; out-of-equilibrium phases such as supercooled liquid can exist. Falling condensate (precipitation) is not considered part of the working fluid because it generally cannot be assumed to be in thermal equilibrium with the surrounding fluid; it is treated separately.</p><p>The density of the moist air is denoted by <span>$œÅ$</span>. We use the following notation for the mass fractions of the moist air mixture (mass of a constituent divided by the total mass of the working fluid):</p><ul><li><span>$q_d$</span>: dry air mass fraction</li><li><span>$q_v$</span>: water vapor specific humidity</li><li><span>$q_l$</span>: liquid water specific humidity</li><li><span>$q_i$</span>: ice specific humidity</li><li><span>$q_c = q_l + q_i$</span>: condensate specific humidity</li><li><span>$q_t = q_v + q_c$</span>: total specific humidity</li></ul><p>Because this enumerates all constituents of the working fluid, we have <span>$q_t + q_d = 1$</span>. In Earth&#39;s atmosphere, the water vapor specific humidity <span>$q_v$</span> generally dominates the total specific humidity <span>$q_t$</span> and is usually <span>$ùí™(10^{-2})$</span> or smaller; the condensate specific humidity is typically <span>$ùí™(10^{-4})$</span>. Hence, water is a trace constituent of the atmosphere, and only a small fraction of atmospheric water is in condensed phases.</p><p>The pressure <span>$p$</span> of the working fluid is the sum of the partial pressures of dry air and water vapor, both taken to be ideal gases. Neglecting the volume of the condensed phases (but not their masses), this gives <span>$p = œÅ (R_d q_d + R_v q_v) T$</span>, where <span>$R_d$</span> is the specific gas constant of dry air, and <span>$R_v$</span> is the specific gas constant of water vapor.</p><p>This can also be written as</p><p class="math-container">\[\begin{equation}
    p = œÅ R_m T,
\label{e:eos}
\end{equation}\]</p><p>where</p><p class="math-container">\[\begin{equation}
\begin{aligned}
    R_m(q) &amp; = R_d (1 - q_t) + R_v q_v \\
        &amp; = R_d \left[ 1 + (Œµ_{dv}-1)q_t - Œµ_{dv} q_c\right]
\end{aligned}
\label{e:Rm}
\end{equation}\]</p><p>is the specific gas <span>$constant$</span> of moist air (which is not a constant); here, we have used <span>$q_d = 1-q_t$</span> and <span>$q_v = q_t - q_c$</span> and introduced the ratio of the molar masses of dry air and water vapor <span>$Œµ_{dv} = R_v/R_d$</span> (‚âà 1.61). Equations \eqref{e:eos} and \eqref{e:Rm} constitute the equation of state of the working fluid. We use the notation <span>$q=(q_t, q_l, q_i)$</span> for the tuple of specific humidities that determine the composition of moist air.</p><h2 id="Heat-Capacities"><a class="docs-heading-anchor" href="#Heat-Capacities">Heat Capacities</a><a id="Heat-Capacities-1"></a><a class="docs-heading-anchor-permalink" href="#Heat-Capacities" title="Permalink"></a></h2><p>The isochoric specific heat capacities of the constituents of moist air are:</p><ul><li><span>$c_{vd}$</span>: Isochoric specific heat capacity of dry air;</li><li><span>$c_{vv}$</span>: Isochoric specific heat capacity of water vapor;</li><li><span>$c_{vl}$</span>: Isochoric specific heat capacity of liquid water;</li><li><span>$c_{vi}$</span>: Isochoric specific heat capacity of ice.</li></ul><p>Our key thermodynamic approximation is to take these isochoric specific heat capacities to be constants, i.e., we take the gases to be calorically perfect. This is an approximation because they depend weakly on temperature. But for atmospheric conditions, the error of approximating them as constant is less than 1% for dry air, the main constituent of moist air, and at most a few percent for the water phases.</p><p>The difference between the isochoric and isobaric specific heat capacities is proportional to the specific volume. Consistent with taking the specific volume of liquid water and ice to be zero, we take the isochoric and isobaric specific heat capacities of the condensed phases to be equal. The isobaric specific heat capacities of the constituents then are:</p><ul><li><span>$c_{pd} = c_{vd} + R_d$</span>: Isobaric specific heat capacity of dry air;</li><li><span>$c_{pv} = c_{vv} + R_v$</span>: Isobaric specific heat capacity of water vapor;</li><li><span>$c_{pl} = c_{vl}$</span>: Isobaric specific heat capacity of liquid water;</li><li><span>$c_{pi} = c_{vi}$</span>: Isobaric specific heat capacity of ice.</li></ul><p>The corresponding specific heat capacities of moist air are the weighted sum of those of the constituents:</p><p class="math-container">\[\begin{equation}
\begin{aligned}
    c_{‚ãÖ m}(q) &amp; = (1-q_t) c_{‚ãÖ d} + q_v c_{‚ãÖ v} + q_l c_{‚ãÖ l} + q_i c_{‚ãÖ i} \\
    &amp; = c_{‚ãÖ d} + (c_{‚ãÖ v} - c_{‚ãÖ d})q_t + (c_{‚ãÖ l} - c_{‚ãÖ v})q_l + (c_{‚ãÖ i} - c_{‚ãÖ v})q_i
\end{aligned}
\label{e:SpecificHeat}
\end{equation}\]</p><p>where <span>$‚ãÖ$</span> stands for <span>$v$</span> or <span>$p$</span> and we have used <span>$q_v = q_t -q_l - q_i$</span>. Straightforward substitution shows that the above relation between the specific heat capacities of the constituents also holds for moist air as a whole:</p><p class="math-container">\[\begin{equation}\label{e:SpecificHeatRelation}
    c_{pm}(q) = c_{vm}(q) + R_m(q).
\end{equation}\]</p><h2 id="Latent-Heats"><a class="docs-heading-anchor" href="#Latent-Heats">Latent Heats</a><a id="Latent-Heats-1"></a><a class="docs-heading-anchor-permalink" href="#Latent-Heats" title="Permalink"></a></h2><p>Kirchhoff&#39;s relation states that the specific latent enthalpy (heat) <span>$L$</span> of a phase change depends on temperature <span>$T$</span> through</p><p class="math-container">\[\begin{equation}
    \frac{dL}{dT} = Œî c_p,
\end{equation}\]</p><p>where <span>$Œî c_p$</span> is the difference in isobaric specific heat capacities between the phase with the higher and lower specific volume. For the constant isobaric specific heat capacities that we assume, this can be integrated to give</p><p class="math-container">\[\begin{equation}
    L(T) = L_0 + Œî c_p (T-T_0),
    \label{e:LHTemperature}
\end{equation}\]</p><p>where <span>$T_0$</span> is a reference temperature and <span>$L_0$</span> is the specific latent heat at <span>$T_0$</span>.</p><p>For the phase transitions of water, this implies specifically:</p><ul><li><span>$L_v(T) = L_{v,0} + (c_{pv} - c_{pl}) (T - T_0)$</span>: Latent heat of vaporization;</li><li><span>$L_f(T) = L_{f,0} + (c_{pl} - c_{pi}) (T - T_0)$</span>: Latent heat of fusion;</li><li><span>$L_s(T) = L_{s,0} + (c_{pv} - c_{pi}) (T - T_0)$</span>: Latent heat of sublimation.</li></ul><p>With <span>$L_{s,0} = L_{v,0} + L_{f,0}$</span>, this gives <span>$L_s(T) = L_v(T) + L_f(T)$</span>, as it should.</p><h2 id="Internal-Energies"><a class="docs-heading-anchor" href="#Internal-Energies">Internal Energies</a><a id="Internal-Energies-1"></a><a class="docs-heading-anchor-permalink" href="#Internal-Energies" title="Permalink"></a></h2><p>The specific internal energies of the constituents of moist air can be written as</p><p class="math-container">\[\begin{equation}
\begin{aligned}
I_d(T) &amp; = c_{vd} (T - T_0),  \\
I_v(T) &amp; = c_{vv} (T - T_0) + I_{v,0},\\
I_l(T) &amp; = c_{vl} (T - T_0), \\
I_i(T) &amp; = c_{vi} (T - T_0) - I_{i,0}.
\end{aligned}
\label{e:InternalEnergies}
\end{equation}\]</p><p>Here, the reference specific internal energy <span>$I_{v,0}$</span> is the difference in specific internal energy between vapor and liquid at the reference temperature <span>$T_0$</span>, and <span>$I_{i,0}$</span> is the difference in specific internal energy between ice and liquid at <span>$T_0$</span>. The internal energy of moist air is the weighted sum of that of the constituents,</p><p class="math-container">\[\begin{equation}
\begin{aligned}
     I(T, q) &amp; = (1-q_t) I_d(T) + q_v I_v(T) + q_l I_l(T) + q_i I_i(T)\\
          &amp; = c_{vm}(q) (T - T_0)  + q_v I_{v,0} - q_i I_{i,0}.
\end{aligned}
\label{e:totalInternalEnergy}
\end{equation}\]</p><p>The internal energy can be inverted to obtain the temperature given <span>$I$</span> and the specific humidities,</p><p class="math-container">\[\begin{equation}
    T = T_0 + \frac{I - (q_t - q_l) I_{v,0} + q_i (I_{i,0} + I_{v,0})}{c_{vm}(q)},
    \label{e:temperature}
\end{equation}\]</p><p>where we have used <span>$q_v = q_t - q_l - q_i$</span>. This allows one to recover temperature given internal energy and specific humidities as state variables.</p><p>The reference specific internal energies <span>$I_{v,0}$</span> and <span>$I_{i,0}$</span> are related to the reference specific latent heats <span>$L_{v,0}$</span> and <span>$L_{f,0}$</span>, which indicate the enthalpy differences between the phases at <span>$T_0$</span>. The reference specific internal energies are obtained from the reference specific latent heats by subtracting the <span>$pV$</span> term, which is <span>$p_k/œÅ_k$</span> for the relevant partial pressure <span>$p_k$</span> and specific volume <span>$1/œÅ_k$</span> of the phase <span>$k$</span> (and hence is zero for the condensed phases, whose specific volume we neglect). This gives</p><p class="math-container">\[\begin{equation}
\begin{aligned}
     I_{v,0} &amp;= L_{v, 0} - R_v T_0,\\
     I_{i,0} &amp;= L_{f, 0}.
\end{aligned}
\label{e:RefInternalEnergies}
\end{equation}\]</p><h2 id="Enthalpies"><a class="docs-heading-anchor" href="#Enthalpies">Enthalpies</a><a id="Enthalpies-1"></a><a class="docs-heading-anchor-permalink" href="#Enthalpies" title="Permalink"></a></h2><p>The specific enthalpies of the constituents of moist air are obtained by adding <span>$p_k/œÅ_k$</span> for phase <span>$k$</span> to the corresponding specific internal energy \eqref{e:InternalEnergies}. Again neglecting the specific volumes of the condensed phases and using the relations \eqref{e:RefInternalEnergies} between reference specific energies and latent heats, this gives:</p><p class="math-container">\[\begin{equation}
\label{e:Enthalpies}
\begin{aligned}
    h_d(T) = I_d(T) + R_d T &amp;= c_{pd}(T-T_0) + R_d T_0, \\
    h_v(T) = I_v(T) + R_v T &amp;= c_{pv}(T-T_0) + L_{v,0}, \\
    h_l(T) = I_l(T) &amp;= c_{pl}(T-T_0), \\
    h_i(T) = I_i(T) &amp;= c_{pi}(T-T_0) - L_{f,0}.
\end{aligned}
\end{equation}\]</p><p>The enthalpy of moist air is the weighted sum of the constituent enthalpies:</p><p class="math-container">\[\begin{equation}
\begin{split}\label{e:enthalpy_definition}
    h(T, q)  &amp;= (1-q_t) h_d + q_v h_v + q_l h_l + q_i h_i \\
        &amp;= c_{pm}(q) (T-T_0) + q_v L_{v,0} - q_i L_{f,0} + (1-q_t) R_d T_0\\
        &amp;= I(q, T) + R_m T,
\end{split}
\end{equation}\]</p><p>where the last equality used <span>$c_{pm} = c_{vm} + R_m$</span> (Eq. \ref{e:SpecificHeatRelation}). The enthalpy is the relevant thermodynamic energy quantity in fluid transport. It arises in boundary conditions for energy fluxes and in the modeling of subgrid-scale (SGS) turbulent transport. For those purposes, we need gradients of the enthalpy, which can be written as</p><p class="math-container">\[\begin{equation}
\label{e:EnthalpyGradient}
    ‚àáh = c_{pm}(q) ‚àáT - h_d(T) ‚àáq_t
    + h_v(T) ‚àáq_v + h_l(T) ‚àáq_l + h_i(T) ‚àáq_i.
\end{equation}\]</p><p>This cleanly separates gradients involving temperature and gradients involving specific humidities.</p><h2 id="Moist-Static-Energy"><a class="docs-heading-anchor" href="#Moist-Static-Energy">Moist Static Energy</a><a id="Moist-Static-Energy-1"></a><a class="docs-heading-anchor-permalink" href="#Moist-Static-Energy" title="Permalink"></a></h2><p>The sum of the specific enthalpy of moist air and the specific gravitational potential energy <span>$Œ¶$</span> is the moist static energy <a href="../References/#Neelin1987">J David Neelin , Isaac M Held  (1987)</a></p><p class="math-container">\[\begin{equation}\label{e:MSE}
\mathrm{MSE} = h + Œ¶.
\end{equation}\]</p><p>Moist static energy arises naturally as the static energy component that is transported in moist air. <span>$Static$</span> here refers to the fact that the (small) kinetic energy contribution to the total energy is neglected (see section TODO). The global integral of moist static energy is approximately conserved in adiabatic processes, even in the presence of reversible phase transitions and latent heat release. It is also approximately materially conserved (<a href="../References/#Romps2015">David M Romps  (2015)</a>).</p><h2 id="Saturation-Vapor-Pressure"><a class="docs-heading-anchor" href="#Saturation-Vapor-Pressure">Saturation Vapor Pressure</a><a id="Saturation-Vapor-Pressure-1"></a><a class="docs-heading-anchor-permalink" href="#Saturation-Vapor-Pressure" title="Permalink"></a></h2><p>The Clausius-Clapeyron relation describes how the saturation vapor pressure <span>$p_v^*$</span> of an ideal gas over a plane surface of condensate depends on temperature:</p><p class="math-container">\[\begin{equation}
\label{e:Clausius_Clapeyron}
    \frac{d \log(p_v^*)}{dT} = \frac{L}{R_v T^2}.
\end{equation}\]</p><p>Here, <span>$L$</span> is the specific latent heat of the phase transition, which is <span>$L_v$</span> for the saturation vapor pressure over liquid, or <span>$L_s$</span> for the saturation vapor pressure over ice. Substituting the linear relation \eqref{e:LHTemperature} between latent heat and temperature, and taking <span>$p_\mathrm{tr}$</span> to be the vapor pressure at the triple point (by definition equal to the saturation vapor pressures both over liquid and ice), the Clausius-Clapeyron relation can be integrated to give a closed-form expression for the vapor pressure that is consistent with our thermodynamic assumptions:</p><p class="math-container">\[\begin{equation}
    p_v^* = p_{\mathrm{tr}} \left( \frac{T}{T_{\mathrm{tr}}} \right)^{\frac{\Delta c_p}{R_v}}
        \exp \left[ \frac{L_0 - \Delta c_p T_0}{R_v}
        \left( \frac{1}{T_{\mathrm{tr}}} - \frac{1}{T} \right) \right].
        \label{e:SatVaporPressure}
\end{equation}\]</p><p>With <span>$L_0 = L_{v,0}$</span> or <span>$L_0 = L_{s,0}$</span> and the corresponding heat capacity difference <span>$\Delta c_p$</span>, this gives saturation vapor pressures over liquid or ice that are accurate within 3% for temperatures between 200K and 330K (with accuracy better than 1% for typical near-surface conditions).</p><p>To obtain the saturation vapor pressure over a mixture of liquid and ice (e.g., in mixed-phase clouds), using a weighted average of the relevant specific latent heats in the vapor pressure \eqref{e:SatVaporPressure} leads to a thermodynamically consistent formulation (<a href="../References/#Pressel2015">Kyle G Pressel , Colleen M Kaul , Tapio Schneider , Zhihong Tan , Siddhartha Mishra  (2015)</a>). That is, if a fraction <span>$Œª_p$</span> of the condensate is liquid and the complement <span>$1-Œª_p$</span> is ice, calculating the saturation vapor pressure with a specific latent heat <span>$Œª_p L_v + (1-Œª_p)L_s$</span> gives a thermodynamically consistent saturation vapor pressure over the mixture.</p><p>In thermodynamic equilibrium, the liquid fraction</p><p class="math-container">\[\begin{equation}\label{e:liquid_fraction}
    Œª_p(T) = \mathcal{H}(T-T_{\mathrm{freeze}})
\end{equation}\]</p><p>is a Heaviside function <span>$\mathcal{H}$</span> of temperature, being 0 below the freezing temperature <span>$T_{\mathrm{freeze}}$</span> and 1 above it. However, out of thermodynamic equilibrium, supercooled liquid can exist between the temperature of homogeneous ice nucleation <span>$T_{\mathrm{icenuc}}$</span> and the freezing temperature <span>$T_{\mathrm{freeze}}$</span>. In most climate models, this is modeled by a continuous function</p><p class="math-container">\[\begin{equation}
    Œª_p(T) =
    \begin{cases}
    0 &amp; \text{for } T\le T_{\mathrm{icenuc}}\\
    0&lt;Œª_i(T)&lt;1 &amp; \text{for } T_{\mathrm{icenuc}} &lt; T &lt;  T_{\mathrm{freeze}}\\
    1   &amp; \text{for } T\ge T_{\mathrm{freeze}},
    \end{cases}
\end{equation}\]</p><p>where <span>$Œª_i$</span> interpolates between 0 at the temperature of homogeneous ice nucleation and 1 at the freezing temperature. However, it is important to recognize that this is merely an attempt to model out-of-equilibrium phases such as supercooled liquid within a thermodynamic equilibrium framework (where phase partitioning only depends on thermodynamic state variables but not on the history of air masses); this is not generally possible, and we will adopt alternative approaches.</p><h2 id="Saturation-Specific-Humidity"><a class="docs-heading-anchor" href="#Saturation-Specific-Humidity">Saturation Specific Humidity</a><a id="Saturation-Specific-Humidity-1"></a><a class="docs-heading-anchor-permalink" href="#Saturation-Specific-Humidity" title="Permalink"></a></h2><p>From the saturation vapor pressure <span>$p_v^*$</span>, the saturation specific humidity can be computed using the ideal gas law \eqref{e:eos}, giving the density of water vapor at saturation <span>$œÅ_v^* = p_v^*(T)/(R_v T)$</span>, and hence the saturation specific humidity </p><p class="math-container">\[\begin{equation}
     q_v^* = \frac{œÅ_v^*}{œÅ} = \frac{p_v^*(T)}{œÅ R_v T}.
\label{e:sat_shum}
\end{equation}\]</p><h2 id="Saturation-Adjustment"><a class="docs-heading-anchor" href="#Saturation-Adjustment">Saturation Adjustment</a><a id="Saturation-Adjustment-1"></a><a class="docs-heading-anchor-permalink" href="#Saturation-Adjustment" title="Permalink"></a></h2><p>Gibbs&#39; phase rule states that in thermodynamic equilibrium, the temperature <span>$T$</span> and liquid and ice specific humidities <span>$q_l$</span> and <span>$q_i$</span> can be obtained from the three thermodynamic state variables density <span>$œÅ$</span>, total water specific humidity <span>$q_t$</span>, and internal energy <span>$I$</span>. Thus, a moist dynamical core that assumes equilibrium thermodynamics can be constructed from a dry dynamical core with total energy as a prognostic variable by including only a tracer for the total specific humidity <span>$q_t$</span>, and calculating the temperature and condensate specific humidities from <span>$œÅ$</span>, <span>$q_t$</span>, and <span>$I$</span>.</p><p>Obtaining the temperature and condensate specific humidities from the state variables <span>$œÅ$</span>, <span>$q_t$</span>, and <span>$I$</span> is the problem of finding the root <span>$T$</span> of</p><p class="math-container">\[\begin{equation}
I^*(T; œÅ, q_t) - I = 0,
\label{e:SatAdjustment}
\end{equation}\]</p><p>where <span>$I^*(T; œÅ, q_t)$</span> is the internal energy at equilibrium. In an unsaturated equilibrium, there is no condensate, so <span>$I^*$</span> is the internal energy with <span>$q_l=q_i=0$</span>. At saturation, the internal energy <span>$I^*$</span> depends on the vapor specific humidity, <span>$q_v = q_v^*(T, œÅ)$</span>, and on the saturation excess (total condensate)</p><p class="math-container">\[\begin{equation}
q_c^* = \max\bigl[q_t - q_v^*(T, œÅ), 0\bigr],
\end{equation}\]</p><p>which is partitioned according to the liquid fraction <span>$Œª_p$</span> into</p><p class="math-container">\[\begin{equation}
q_l^* = Œª_p(T) q_c^* \quad \text{and} \quad q_i^* = \bigl[1-Œª_p(T)\bigr]q_c^*.
\label{e:PhasePartition}
\end{equation}\]</p><p>In saturated conditions, finding the root of \eqref{e:SatAdjustment} is a nonlinear problem, which must be solved iteratively or approximately, in what is known as a saturation adjustment procedure.</p><p>A zeroth-order approximation of the temperature <span>$T$</span> satisfying the saturation adjustment condition \eqref{e:SatAdjustment} is obtained by assuming unsaturated conditions. In that case, the expression \eqref{e:temperature} for temperature, with <span>$q_l=q_i=0$</span>, gives the unsaturated temperature</p><p class="math-container">\[\begin{equation}
    T_1 = T_0 + \frac{I - q_t I_{v,0}}{c_{vm}^*}.
\end{equation}\]</p><p>Here, the isochoric specific heat capacity in equilibrium, <span>$c_{vm}^* = c_{vm}(q^*)$</span>, is the specific heat capacity under equilibrium partitioning <span>$q^*$</span> of the phases, which here, for unsaturated conditions, means <span>$q^*=(q_t; q_l=0, q_i=0)$</span>. If the total specific humidity <span>$q_t$</span> is less than the saturation specific humidity at <span>$T_1$</span> (<span>$q_t \le q_v^*(T_1, œÅ)$</span>), the air is indeed unsaturated, and <span>$T=T_1$</span> is the exact temperature consistent given <span>$I$</span>, <span>$œÅ$</span>, and <span>$q_t$</span>. </p><p>If the air is saturated (<span>$q_t &gt; q_v^*(T_1, œÅ)$</span>), successively improved temperature estimates <span>$T_{n+1}$</span> can be obtained from the temperature <span>$T_n$</span> (<span>$n=1,\dots$</span>) by Newton&#39;s method, with analytical gradients. Linearizing the saturation internal energy <span>$I^*(T; œÅ, q_t)$</span> around the temperature <span>$T_n$</span> gives</p><p class="math-container">\[\begin{equation}
    I^*(T; œÅ, q_t) \approx I^*(T_n; œÅ, q_t) + \left.\frac{\partial I^*(T; œÅ; q_t)}{\partial T}\right|_{T_n} (T - T_n),
\end{equation}\]</p><p>and solving for the temperature <span>$T$</span> gives the first-order Newton update</p><p class="math-container">\[\begin{equation}
    T_{n+1} = T_{n} - \frac{I^*(T_{n}; œÅ, q_t) - I}{(\partial I^*/\partial T)|_{T_{n}}}.
\end{equation}\]</p><p>The derivative <span>$\partial I^*/\partial T|_{T_n}$</span> is obtained by differentiation of the internal energy \eqref{e:total<em>internal</em>energy}, \hl{[add derivatives of phase partitioning function and make that function smooth]}</p><p class="math-container">\[\begin{multline}
     \left.\frac{\partial I^*(T; œÅ, q_t)}{\partial T}\right|_{T_n} 
     = c_{vm}^*(q_t, T_n) \\
     +  \left( I_{v,0} + [1-Œª_p(T_n)]I_{i,0} + (T_n - T_0) \left. \frac{dc_{vm}^*}{dq_v^*}\right|_{T_n} \right) \left. \frac{\partial q_v^*(T; œÅ, q_t)}{\partial T}\right|_{T_n},
\end{multline}\]</p><p>where <span>$c_{vm}^*(q_t, T_n) = c_{vm}[q^*(T_n)]$</span> is the isochoric specific heat in equilibrium at temperature <span>$T_n$</span>, with <span>$q_v = q_v^*(T_n)$</span> and with the corresponding phase partitioning <span>$q^* = (q_t, q_l^*, q_i^*)$</span> according to \eqref{e:PhasePartition}. The derivative of the saturation specific humidity, <span>$\partial q_v^*(T;œÅ, q_t)/\partial T$</span>, is to be taken at a fixed density <span>$œÅ$</span> and total specific humidity <span>$q_t$</span>, like the other derivatives. We have neglected the singular derivative of <span>$Œª_p$</span> at the freezing temperature <span>$T_{\mathrm{freeze}}$</span>. The two remaining derivatives are that of the isochoric specific heat,</p><p class="math-container">\[\begin{equation}
    \left. \frac{dc_{vm}^*}{dq_v^*}\right|_{T_n} = c_{vv} - Œª_p(T_n) c_{vl} - [1-Œª_p(T_n)]c_{vi},
\end{equation}\]</p><p>obtained from the definition \eqref{e:SpecificHeat} of the specific heat of moist air, and that of the saturation specific humidity,</p><p class="math-container">\[\begin{equation}
    \left. \frac{\partial q_v^*(T; œÅ, q_t)}{\partial T}\right|_{T_n} = q_v^*(T_n) \frac{L}{R_v T_n^2} \quad \text{with} \quad L = Œª_p(T_n) L_v + [1-Œª_p(T_n)] L_s,
\end{equation}\]</p><p>obtained from the Clausius-Clapeyron relation \eqref{e:Clausius<em>Clapeyron} and the relation \eqref{e:sat</em>shum} between specific humidity and vapor pressure. </p><p>The resulting successive Newton approximations <span>$T_n$</span> generally converge quadratically. Because condensate specific humidities are usually small, <span>$T_1$</span> provides a close initial estimate, and few iterations are needed. Even the first-order approximation <span>$T\approx T_2$</span> often suffices. However, convergence may not be achieved near the phase transition at the freezing temperature <span>$T_{\mathrm{freeze}}$</span> because the derivative of <span>$I^*$</span> with respect to temperature is discontinuous there. In that case, the number of iterations needs to be limited (2‚Äì3 iterations generally suffice). </p><p>Using saturation adjustment makes it possible to construct a moist dynamical core that has the total specific humidity <span>$q_t$</span> as the only prognostic moisture variable. The price for this simplicity is the necessity to solve a nonlinear problem iteratively (or approximately) at each time step, and being confined to an equilibrium thermodynamics framework which cannot adequately account for non-equilibrium processes. Using explicit tracers for the condensates <span>$q_l$</span> and <span>$q_i$</span> in addition to <span>$q_t$</span> avoids iterations at each time step and allows the inclusion of explicit non-equilibrium processes, such as those leading to the formation of supercooled liquid in mixed-phase clouds. </p><h2 id="Auxiliary-Thermodynamic-Functions"><a class="docs-heading-anchor" href="#Auxiliary-Thermodynamic-Functions">Auxiliary Thermodynamic Functions</a><a id="Auxiliary-Thermodynamic-Functions-1"></a><a class="docs-heading-anchor-permalink" href="#Auxiliary-Thermodynamic-Functions" title="Permalink"></a></h2><p>Several auxiliary thermodynamic functions are commonly used.</p><h3 id="Relative-Humidity"><a class="docs-heading-anchor" href="#Relative-Humidity">Relative Humidity</a><a id="Relative-Humidity-1"></a><a class="docs-heading-anchor-permalink" href="#Relative-Humidity" title="Permalink"></a></h3><p>The relative humidity is defined as the ratio of the partial pressure of water vapor <span>$p_v$</span> to the saturation vapor pressure <span>$p_v^*$</span>,</p><p class="math-container">\[\mathrm{RH} = \frac{p_v}{p_v^*}.\]</p><p>Using the ideal gas law for water vapor, <span>$p_v = q_v œÅ R_v T$</span>, this can be written as</p><p class="math-container">\[\begin{equation}
    \mathrm{RH} = \frac{q_v œÅ R_v T}{p_v^*},
\end{equation}\]</p><p>where <span>$p_v^*$</span> is the saturation vapor pressure \eqref{e:SatVaporPressure}. Over a mixture of ice and liquid, the saturation vapor pressure \eqref{e:SatVaporPressure} is evaluated with a specific latent heat <span>$L = Œª_p L_v + (1-Œª_p) L_s$</span> that is a weighted sum of those for vaporization and sublimation.</p><h3 id="Potential-Temperature"><a class="docs-heading-anchor" href="#Potential-Temperature">Potential Temperature</a><a id="Potential-Temperature-1"></a><a class="docs-heading-anchor-permalink" href="#Potential-Temperature" title="Permalink"></a></h3><p>The potential temperature <span>$Œ∏$</span> is the temperature an air mass would have if brought adiabatically from pressure <span>$p$</span> and temperature <span>$T$</span> to some reference pressure <span>$p_0$</span> (typically taken to be mean sea level pressure):</p><p class="math-container">\[\begin{equation}
Œ∏ = \frac{T}{\Pi},
\label{e:PotTempPressT}
\end{equation}\]</p><p>where <span>$\Pi$</span> is known as the Exner function</p><p class="math-container">\[\begin{equation}
    \Pi  = \left( \frac{p}{p_0} \right)^Œ∫ \quad \text{with} \quad Œ∫ = \frac{R_m}{c_{pm}}.
\end{equation}\]</p><p>Note that the adiabatic exponent <span>$Œ∫$</span> takes the effect of  moisture on the effective gas <span>$constant$</span> and specific heat capacity of air into account.</p><h3 id="Virtual-(Potential)-Temperature"><a class="docs-heading-anchor" href="#Virtual-(Potential)-Temperature">Virtual (Potential) Temperature</a><a id="Virtual-(Potential)-Temperature-1"></a><a class="docs-heading-anchor-permalink" href="#Virtual-(Potential)-Temperature" title="Permalink"></a></h3><p>The virtual or density temperature <span>$T_v$</span> is the temperature dry air would need to have to have the same density as moist air at the same pressure. Using the ideal gas law <span>$p/œÅ = R_m T$</span>, this implies <span>$R_m T  = R_d T_v$</span>, or</p><p class="math-container">\[\begin{equation}\label{e:virtual_temp}
T_v = \frac{R_m}{R_d} T.
\end{equation}\]</p><p>A virtual potential temperature can be defined analogously:</p><p class="math-container">\[\begin{equation}
Œ∏_v = \frac{R_m}{R_d} Œ∏.
\label{e:virtual_pottemp}
\end{equation}\]</p><p>Some texts distinguish virtual and density (potential) temperatures, where density (potential) temperatures take the mass of condensate into account, whereas virtual (potential) temperatures do not. We always take the mass of any condensate into account in the thermodynamics of moist air and do not make this distinction here.</p><h3 id="Liquid-Ice-Potential-Temperature"><a class="docs-heading-anchor" href="#Liquid-Ice-Potential-Temperature">Liquid-Ice Potential Temperature</a><a id="Liquid-Ice-Potential-Temperature-1"></a><a class="docs-heading-anchor-permalink" href="#Liquid-Ice-Potential-Temperature" title="Permalink"></a></h3><p>When the amount of condensate in air is small and the temperature <span>$T$</span> is not too small (e.g., <a href="../References/#Tripoli1981">Gregory J Tripoli , William R Cotton  (1981)</a>), the (linearized) liquid-ice potential temperature,</p><p class="math-container">\[\begin{equation}\label{e:liquid_ice_pottemp}
Œ∏_{li} = Œ∏ \left( 1 - \frac{L_{v,0} q_l + L_{s, 0} q_i}{c_{pm} T} \right),
\end{equation}\]</p><p>is approximately materially conserved in adiabatic and reversible processes (including phase transitions). It is approximately the potential temperature \eqref{e:PotTempPressT} an air parcel would have if all liquid water in the parcel were evaporated and all ice sublimated. It is the limit of a more general expression for liquid-ice potential temperature for small <span>$q_l$</span> and <span>$q_i$</span> and taking the specific latent heats to be constant (e.g., <a href="../References/#Bryan2004">George H Bryan , J Michael Fritsch  (2004)</a>). The liquid-ice potential temperature \eqref{e:liquid<em>ice</em>pottemp} and variants thereof are sometimes used as variables in numerical models. We use it for diagnostic purposes, for comparison with other studies.</p><p>The liquid-ice potential temperature <span>$Œ∏_{li}$</span> can be inverted for the temperature given pressure <span>$p$</span> (and hence <span>$\Pi$</span>) and the specific humidities <span>$q_t$</span>, <span>$q_l$</span>, and <span>$q_i$</span>:</p><p class="math-container">\[\begin{equation}
    T = \Pi Œ∏_{li} + \frac{L_{v, 0} q_l + L_{s, 0} q_i}{c_{pm}}.
\label{e:TempFromThetaLiGivenP}
\end{equation}\]</p><p>Alternatively, when density <span>$œÅ$</span> instead of pressure <span>$p$</span> is given, the temperature can be obtained by Taylor expansion from the liquid-ice potential temperature <span>$Œ∏_{li}$</span>,</p><p class="math-container">\[\begin{equation}
T \approx T_u + \frac{L_{v,0} q_l + L_{s,0}q_i}{c_{vm}} - \frac{Œ∫}{2} \frac{1}{T_u}\left(\frac{L_{v,0} q_l + L_{s,0} q_i}{c_{vm}}\right)^2
\end{equation}
\label{e:TempFromThetaLiGivenRho}\]</p><p>where</p><p class="math-container">\[\begin{equation}
   T_u =  \left( \frac{œÅ R_m Œ∏_{li}}{p_0} \right)^{R_m/c_{vm}} Œ∏_{li}
\end{equation}\]</p><p>is the temperature that would correspond to <span>$Œ∏_{li}$</span> in unsaturated conditions, i.e., when the condensate specific humidities <span>$q_l$</span> and <span>$q_i$</span> are zero. However, the specific heats <span>$c_{vm}$</span> and <span>$c_{pm}$</span> and the moist gas constant <span>$R_m$</span> are evaluated with the given total and condensate specific humidities <span>$q_t$</span>, <span>$q_l$</span>, and <span>$q_i$</span>.</p><p>TODO: there was a commented equation here, do we need it?</p><p>This expression for temperature as a function of liquid-ice potential temperature is obtained from \eqref{e:TempFromThetaLiGivenP} by substituting for pressure in the Exner function <span>$\Pi$</span> from the ideal gas law, <span>$p=œÅ R_m T$</span>, solving for temperature using a second-order Taylor expansion around <span>$T_u$</span> for small condensate specific humidities, and using the relation <span>$1-Œ∫ = c_{vm}/c_{pm}$</span>, which follows from <span>$c_{pm} - R_m = c_{vm}$</span>. The relation for temperature \eqref{e:TempFromThetaLiGivenRho} holds to second order in condensate specific humidities <span>$q_l$</span> and <span>$q_i$</span>. That is, the inversion relation \eqref{e:TempFromThetaLiGivenRho} holds to one higher order of accuracy than the definition of the liquid-ice potential temperature \eqref{e:liquid<em>ice</em>pottemp} itself, which is only first-order accurate in the condensate specific humidities <span>$q_l$</span> and <span>$q_i$</span>.</p><h3 id="Speed-of-Sound"><a class="docs-heading-anchor" href="#Speed-of-Sound">Speed of Sound</a><a id="Speed-of-Sound-1"></a><a class="docs-heading-anchor-permalink" href="#Speed-of-Sound" title="Permalink"></a></h3><p>The speed of sound in (moist) unstratified air is</p><p class="math-container">\[\begin{equation}
 c_s = \left(\frac{c_{pm}}{c_{vm}} R_m T \right)^{1/2},
\label{e:soundspeed}
\end{equation}\]</p><p>with the appropriate gas constants for moist air. In the presence of stratification, additional terms arise (<a href="../References/#Durran1999">Dale R Durran  (1999)</a>).</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../DevDocs/">¬´ Developer docs</a><a class="docs-footer-nextpage" href="../References/">References ¬ª</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> on <span class="colophon-date" title="Monday 7 June 2021 18:13">Monday 7 June 2021</span>. Using Julia version 1.6.0.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
